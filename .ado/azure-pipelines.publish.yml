# Build pipeline for publishing

trigger:
  batch: true
  branches:
    include:
      - master

pr: none

variables:
  - group: 'NPM and Github Secrets'

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '12.x'
    displayName: 'Install Node.js'

  - script: |
      git config user.name "UI-Fabric-RN-Bot"
      git config user.email "uifrnbot@microsoft.com"
      git remote set-url origin https://$(githubUser):$(githubPAT)@github.com/microsoft/ui-fabric-react-native.git
    displayName: Git Authentication
  - template: templates/yarn-install.yml

  - script: |
      yarn test
    displayName: 'yarn test'
  - script: |
      yarn publish:beachball -- -b origin/master -n $(npmAuth) --access public -y
    displayName: 'Publish NPM Packages'

  # - template: templates/publish-nuget-job.yml

  # generate the sanitizedBuildNumber environment variable
  - bash: 'scripts/generate_build_number.sh'
    displayName: 'Generate Build Number'

  # pack the nuspec
  - task: NuGetCommand@2
    displayName: 'NuGet pack'
    inputs:
      command: pack
      packagesToPack: 'FluentUI.nuspec'
      buildProperties: buildNumber=$(sanitizedBuildNumber);commitId=$(Build.SourceVersion);repoUri=$(Build.Repository.Uri)

  # push the package package
  - task: NuGetCommand@2
    displayName: 'NuGet push'
    inputs:
      command: push
      packagesToPush: '$(Build.ArtifactStagingDirectory)/Microsoft.FluentUI.ReactNative.*.nupkg'
      nuGetFeedType: external
      publishFeedCredentials: Office
