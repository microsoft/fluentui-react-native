# Build pipeline for publishing

trigger:
  batch: true
  branches:
    include:
      - main
      - releases/*

pr: none

parameters:
  - name: skipNpmPublish
    displayName: Skip Npm Publish
    type: boolean
    default: false
  - name: skipNugetPublish
    displayName: Skip Nuget Publish
    type: boolean
    default: false

variables:
  - group: 'FluentUI React Native Secrets'
  - group: InfoSec-SecurityResults
  - name: tags
    value: production,externalfacing
  - template: variables/vars.yml

resources:
  repositories:
    - repository: OfficePipelineTemplates
      type: git
      name: 1ESPipelineTemplates/OfficePipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/Office.Official.PipelineTemplate.yml@OfficePipelineTemplates
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      image: windows-latest
      os: windows
    sdl:
      eslint:
        configuration: 'recommended'
        parser: '@typescript-eslint/parser'
        parserOptions: 'sourceType:script\necmaVersion:2017'
        customEnvironments: true
        environmentsBrowser: true
        environmentsEs6: true
        environmentsNode: true
    stages:
      - stage: main
        jobs:
          - job: NPMPublish
            displayName: NPM Publish
            pool:
              name: Azure-Pipelines-1ESPT-ExDShared
              image: ubuntu-latest
              os: linux
            templateContext:
              outputs:
                - output: pipelineArtifact
                  targetPath: $(System.DefaultWorkingDirectory)
                  artifactName: dist
            steps:
              - template: .ado/templates/setup-repo.yml@self

              - script: |
                  yarn
                displayName: 'yarn install'

              - script: |
                  yarn buildci
                displayName: 'yarn buildci [test]'

              - script: |
                  yarn config set npmPublishRegistry "https://registry.npmjs.org"
                  yarn config set npmAuthToken $(npmAuth)
                displayName: 'Configure yarn for npm publishing'
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), not(${{ parameters.skipNpmPublish }}))

              - script: |
                  # https://github.com/changesets/changesets/issues/432
                  # We can't use `changeset publish` because it doesn't support workspaces, so we have to publish each package individually
                  yarn workspaces foreach --all --topological --no-private \
                    exec zx $(Build.SourcesDirectory)/.github/scripts/publish-package-if-needed.mts
                displayName: 'Publish NPM Packages'
                condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), not(${{ parameters.skipNpmPublish }}))

              - script: |
                  yarn config unset npmAuthToken
                  yarn config unset npmPublishRegistry
                displayName: 'Cleanup yarn npm config'
                condition: always()

          - template: .ado/templates/win32-nuget-publish.yml@self
            parameters:
              skipNugetPublish: ${{ parameters.skipNugetPublish }}

          - template: .ado/templates/e2e-dependency-nuget-publish.yml@self
            parameters:
              skipNugetPublish: ${{ parameters.skipNugetPublish }}
