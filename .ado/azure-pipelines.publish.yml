# Build and publish pipeline
# This pipeline runs on every commit to main and intelligently detects
# when packages need to be published to NPM

trigger:
  batch: true
  branches:
    include:
      - main

pr: none

parameters:
  - name: skipNpmPublish
    displayName: Skip Npm Publish
    type: boolean
    default: false
  - name: skipNugetPublish
    displayName: Skip Nuget Publish
    type: boolean
    default: false

variables:
  - group: 'FluentUI React Native Secrets'
  - group: InfoSec-SecurityResults
  - name: tags
    value: production,externalfacing
  - name: BRANCH_NAME
    value: 'beachball/version-bump/main'
  - template: variables/vars.yml

resources:
  repositories:
    - repository: OfficePipelineTemplates
      type: git
      name: 1ESPipelineTemplates/OfficePipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/Office.Official.PipelineTemplate.yml@OfficePipelineTemplates
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      image: windows-latest
      os: windows
    sdl:
      eslint:
        configuration: 'recommended'
        parser: '@typescript-eslint/parser'
        parserOptions: 'sourceType:script\necmaVersion:2017'
        customEnvironments: true
        environmentsBrowser: true
        environmentsEs6: true
        environmentsNode: true
    stages:
      # Stage 1: Create version bump PR if change files exist
      - stage: VersionBump
        displayName: 'Create Version Bump PR'
        lockBehavior: sequential
        jobs:
          - job: CreatePR
            displayName: 'Create or Update Version Bump PR'
            pool:
              name: Azure-Pipelines-1ESPT-ExDShared
              image: ubuntu-latest
              os: linux
            steps:
              - checkout: self
                fetchDepth: 0
                persistCredentials: true

              - template: .ado/templates/setup-repo.yml@self

              - script: |
                  set -eox pipefail
                  yarn install --immutable
                displayName: 'Install dependencies'

              # Check if there are change files
              - script: |
                  set -eox pipefail
                  if npx beachball check --verbose; then
                    echo "##vso[task.setvariable variable=HasChangeFiles;isOutput=true]yes"
                    echo "‚úÖ Change files detected"
                  else
                    echo "##vso[task.setvariable variable=HasChangeFiles;isOutput=true]no"
                    echo "‚ÑπÔ∏è No change files found"
                  fi
                name: CheckChanges
                displayName: 'Check for change files'

              # Configure Git
              - script: |
                  set -eox pipefail
                  git config user.name "React Native Bot"
                  git config user.email "53619745+rnbot@users.noreply.github.com"
                displayName: 'Configure Git'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')

              # Check for existing PR
              - task: AzureCLI@2
                displayName: 'Check for existing PR'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')
                inputs:
                  azureSubscription: 'FluentUI React Native'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    set -eox pipefail
                    # Get GitHub token from Key Vault
                    GITHUB_TOKEN=$(az keyvault secret show --vault-name fluentui-rn-keyvault --name github-token --query value -o tsv)
                    export GH_TOKEN=$GITHUB_TOKEN

                    # Check if PR already exists
                    EXISTING_PR=$(gh pr list --head "$(BRANCH_NAME)" --state open --json number --jq '.[0].number' || echo "")

                    if [ -n "$EXISTING_PR" ]; then
                      echo "##vso[task.setvariable variable=ExistingPR;isOutput=true]$EXISTING_PR"
                      echo "üìù Found existing PR #$EXISTING_PR, will update it"
                    else
                      echo "##vso[task.setvariable variable=ExistingPR;isOutput=true]"
                      echo "üìù No existing PR found, will create new one"
                    fi
                name: CheckPR

              # Create or update branch
              - script: |
                  set -eox pipefail
                  # Check if branch exists remotely
                  if git ls-remote --heads origin "$(BRANCH_NAME)" | grep -q "$(BRANCH_NAME)"; then
                    echo "üîÑ Branch exists, updating it"
                    git fetch origin "$(BRANCH_NAME)"
                    git switch "$(BRANCH_NAME)"
                    git reset --hard origin/main
                  else
                    echo "üìù Creating new branch: $(BRANCH_NAME)"
                    git switch -c "$(BRANCH_NAME)"
                  fi
                displayName: 'Create or update version bump branch'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')

              # Run beachball bump
              - script: |
                  set -eox pipefail
                  echo "üîÑ Running beachball bump..."
                  npx beachball bump --verbose
                displayName: 'Run beachball bump'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')

              # Generate PR body with size management
              - script: |
                  set -eox pipefail
                  echo "üìù Generating PR body with size checking..."
                  node scripts/generate-pr-body.ts > pr-body.txt 2> pr-body-log.txt

                  # Show log (sent to stderr by script)
                  cat pr-body-log.txt

                  # Verify file was created
                  if [ ! -f pr-body.txt ]; then
                    echo "‚ùå Failed to generate PR body"
                    exit 1
                  fi

                  echo "‚úÖ PR body generated successfully"
                displayName: 'Generate PR body with size management'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')

              # Commit changes
              - script: |
                  set -eox pipefail
                  git add .

                  # Check if there are any changes to commit
                  if git diff --staged --quiet; then
                    echo "‚ö†Ô∏è No changes after beachball bump, skipping commit"
                    echo "##vso[task.setvariable variable=HasCommit;isOutput=true]no"
                    exit 0
                  fi

                  git commit -m "chore(release): bump package versions [skip ci]"
                  echo "##vso[task.setvariable variable=HasCommit;isOutput=true]yes"
                  echo "‚úÖ Committed version changes"
                name: CommitChanges
                displayName: 'Commit version bumps'
                condition: eq(variables['CheckChanges.HasChangeFiles'], 'yes')

              # Check branch status before push (prevents PR corruption)
              - script: |
                  set -eox pipefail
                  EXISTING_PR="$(CheckPR.ExistingPR)"

                  if [ -n "$EXISTING_PR" ]; then
                    echo "üì• Fetching existing PR branch to preserve history"
                    git fetch origin "$(BRANCH_NAME)" || echo "‚ö†Ô∏è Branch doesn't exist remotely yet"

                    # Check if remote branch exists
                    if git rev-parse origin/"$(BRANCH_NAME)" >/dev/null 2>&1; then
                      # Check if we can fast-forward
                      MERGE_BASE=$(git merge-base HEAD origin/"$(BRANCH_NAME)" 2>/dev/null || echo "")
                      REMOTE_HEAD=$(git rev-parse origin/"$(BRANCH_NAME)" 2>/dev/null || echo "")

                      if [ "$MERGE_BASE" = "$REMOTE_HEAD" ]; then
                        echo "‚úÖ Can fast-forward push"
                        echo "##vso[task.setvariable variable=NeedForcePush;isOutput=true]no"
                      else
                        echo "‚ö†Ô∏è Remote branch diverged, will force push"
                        echo "##vso[task.setvariable variable=NeedForcePush;isOutput=true]yes"
                      fi
                    else
                      echo "üìù Remote branch doesn't exist, will create it"
                      echo "##vso[task.setvariable variable=NeedForcePush;isOutput=true]no"
                    fi
                  else
                    echo "üìù New branch, no fetch needed"
                    echo "##vso[task.setvariable variable=NeedForcePush;isOutput=true]no"
                  fi
                name: CheckBranch
                displayName: 'Check branch status before push'
                condition: and(succeeded(), eq(variables['CheckChanges.HasChangeFiles'], 'yes'), eq(variables['CommitChanges.HasCommit'], 'yes'))

              # Push branch
              - task: AzureCLI@2
                displayName: 'Push version bump branch'
                condition: and(succeeded(), eq(variables['CheckChanges.HasChangeFiles'], 'yes'), eq(variables['CommitChanges.HasCommit'], 'yes'))
                inputs:
                  azureSubscription: 'FluentUI React Native'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    set -eox pipefail
                    # Get GitHub token from Key Vault
                    GITHUB_TOKEN=$(az keyvault secret show --vault-name fluentui-rn-keyvault --name github-token --query value -o tsv)

                    # Configure git to use token for authentication
                    git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/microsoft/fluentui-react-native.git"

                    # Use force-with-lease only if needed
                    if [ "$(CheckBranch.NeedForcePush)" = "yes" ]; then
                      git push --force-with-lease origin "$(BRANCH_NAME)"
                      echo "‚úÖ Force pushed branch (remote diverged)"
                    else
                      git push origin "$(BRANCH_NAME)"
                      echo "‚úÖ Pushed branch (fast-forward)"
                    fi

              # Create or update PR
              - task: AzureCLI@2
                displayName: 'Create or Update Pull Request'
                condition: and(succeeded(), eq(variables['CheckChanges.HasChangeFiles'], 'yes'), eq(variables['CommitChanges.HasCommit'], 'yes'))
                inputs:
                  azureSubscription: 'FluentUI React Native'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    set -eox pipefail
                    # Get GitHub token from Key Vault
                    GITHUB_TOKEN=$(az keyvault secret show --vault-name fluentui-rn-keyvault --name github-token --query value -o tsv)
                    export GH_TOKEN=$GITHUB_TOKEN

                    # Verify PR body file exists
                    if [ ! -f pr-body.txt ]; then
                      echo "‚ùå PR body file not found"
                      exit 1
                    fi

                    EXISTING_PR="$(CheckPR.ExistingPR)"

                    if [ -n "$EXISTING_PR" ]; then
                      # Update existing PR
                      gh pr edit "$EXISTING_PR" \
                        --title "chore(release): bump package versions" \
                        --body-file pr-body.txt

                      PR_URL=$(gh pr view "$EXISTING_PR" --json url --jq '.url')

                      echo "##vso[task.setvariable variable=PRNumber;isOutput=true]$EXISTING_PR"
                      echo "##vso[task.setvariable variable=PRUrl;isOutput=true]$PR_URL"

                      echo "‚úÖ Updated PR #$EXISTING_PR: $PR_URL"
                    else
                      # Create new PR
                      PR_URL=$(gh pr create \
                        --title "chore(release): bump package versions" \
                        --body-file pr-body.txt \
                        --base main \
                        --head "$(BRANCH_NAME)" \
                        --label "automated" \
                        --label "version-bump")

                      PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

                      echo "##vso[task.setvariable variable=PRNumber;isOutput=true]$PR_NUMBER"
                      echo "##vso[task.setvariable variable=PRUrl;isOutput=true]$PR_URL"

                      echo "‚úÖ Created PR #$PR_NUMBER: $PR_URL"
                    fi
                name: CreatePRStep

      # Stage 2: Build and publish packages
      - stage: main
        displayName: 'Build and Publish'
        dependsOn: VersionBump
        condition: always()
        jobs:
          - job: NPMPublish
            displayName: NPM Publish
            pool:
              name: Azure-Pipelines-1ESPT-ExDShared
              image: ubuntu-latest
              os: linux
            templateContext:
              outputs:
                - output: pipelineArtifact
                  targetPath: $(System.DefaultWorkingDirectory)
                  artifactName: dist
            steps:
              - template: .ado/templates/setup-repo.yml@self

              - script: |
                  set -eox pipefail
                  yarn install --immutable
                displayName: 'yarn install'

              - script: |
                  set -eox pipefail
                  yarn buildci
                displayName: 'yarn buildci [test]'

              # Verify NPM authentication before publishing
              - script: |
                  set -eox pipefail
                  echo "üîê Verifying NPM authentication..."

                  # Test authentication by checking access to a public package
                  # Automation tokens should be able to view package info
                  if npm view react version --registry https://registry.npmjs.org/ >/dev/null 2>&1; then
                    echo "‚úÖ NPM registry is accessible"
                  else
                    echo "‚ùå Cannot access NPM registry"
                    exit 1
                  fi

                  # Try to authenticate (works with both user tokens and automation tokens)
                  # This will fail if token is invalid
                  if npm whoami --registry https://registry.npmjs.org/ 2>&1 | grep -qv "ENEEDAUTH\|401\|403"; then
                    echo "‚úÖ NPM authentication successful"
                  else
                    echo "‚ö†Ô∏è  npm whoami failed (expected with automation token)"
                    echo "‚ÑπÔ∏è  Automation tokens don't support whoami, but that's OK"
                    echo "‚ÑπÔ∏è  Will verify authentication during actual publish"
                  fi
                displayName: 'Verify NPM authentication'
                condition: and(succeeded(), ne('${{ parameters.skipNpmPublish }}', true))
                continueOnError: true

              - script: |
                  set -eox pipefail
                  echo ##vso[task.setvariable variable=SkipNpmPublishArgs]--no-publish
                displayName: Enable No-Publish (npm)
                condition: ${{ parameters.skipNpmPublish }}

              - script: |
                  set -eox pipefail
                  if node scripts/check-packages-need-publishing.ts; then
                    echo "##vso[task.setvariable variable=PackagesNeedPublishing]true"
                    echo "‚úÖ Packages need publishing"
                  else
                    echo "##vso[task.setvariable variable=PackagesNeedPublishing]false"
                    echo "‚ÑπÔ∏è No packages need publishing (all versions already exist on NPM)"
                  fi
                displayName: 'Check if packages need publishing'
                condition: and(succeeded(), ne('${{ parameters.skipNpmPublish }}', true))

              - script: |
                  set -eox pipefail

                  # Run publish and capture output for failure detection
                  echo "üì¶ Publishing packages to NPM..."

                  if ! npx beachball publish --no-bump --no-push $(SkipNpmPublishArgs) \
                       --access public --token $(npmAuth) -y --verbose 2>&1 | tee publish-output.txt; then

                    echo ""
                    echo "‚ùå Beachball publish command failed"
                    echo ""

                    # Check for partial success (some packages published, others failed)
                    if grep -q -i "successfully published\|published successfully" publish-output.txt; then
                      echo "::warning::‚ö†Ô∏è PARTIAL SUCCESS - Some packages published, others failed"
                      echo ""
                      echo "‚úÖ Successfully published:"
                      grep -i "successfully published\|published successfully" publish-output.txt || echo "  (none found in output)"
                      echo ""
                      echo "‚ùå Failed to publish:"
                      grep -i "failed to publish\|error publishing\|npm ERR!" publish-output.txt | head -20 || echo "  (check full logs for details)"
                      echo ""
                      echo "‚ùå Not all packages were published. Manual intervention required."
                      echo "Please review the logs above and manually publish any failed packages."
                    else
                      echo "‚ùå No packages were published successfully"
                    fi

                    exit 1
                  fi

                  echo ""
                  echo "‚úÖ All packages published successfully"
                displayName: 'Publish NPM Packages with failure detection'
                condition: and(succeeded(), eq(variables['PackagesNeedPublishing'], 'true'))

              # Create GitHub releases for published packages
              - task: AzureCLI@2
                displayName: 'Create GitHub Releases'
                condition: and(succeeded(), eq(variables['PackagesNeedPublishing'], 'true'), ne('${{ parameters.skipNpmPublish }}', true))
                inputs:
                  azureSubscription: 'FluentUI React Native'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    set -eox pipefail

                    # Get GitHub token from Key Vault
                    GITHUB_TOKEN=$(az keyvault secret show --vault-name fluentui-rn-keyvault --name github-token --query value -o tsv)
                    export GH_TOKEN=$GITHUB_TOKEN

                    # Create releases for published packages
                    node scripts/create-github-releases.ts

          - template: .ado/templates/win32-nuget-publish.yml@self
            parameters:
              skipNugetPublish: ${{ parameters.skipNugetPublish }}

          - template: .ado/templates/e2e-dependency-nuget-publish.yml@self
            parameters:
              skipNugetPublish: ${{ parameters.skipNugetPublish }}
