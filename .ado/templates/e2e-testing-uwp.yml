jobs:
  - job: E2E_UWP_TEST
    displayName: E2E UWP Testing
    timeoutInMinutes: 60 # how long to run the job before automatically cancelling
    cancelTimeoutInMinutes: 5 # how much time to give 'run always even if cancelled tasks' before killing them

    pool:
      vmImage: "windows-2019"

    steps:
      - checkout: self
        persistCredentials: true

      - task: NodeTool@0
        inputs:
          versionSpec: "12.x"
        displayName: "Install Node.js"

      - task: DownloadSecureFile@1
        name: UwpCertificate
        displayName: "Download UWP App Certificate"
        inputs:
          secureFile: "FluentTester_TemporaryKey.pfx"

      # - task: NuGetToolInstaller@0
      #   inputs:
      #     versionSpec: ">=4.6.0"
      #   displayName: "Install Nuget"

      # Clone the artifact repo
      - task: CmdLine@2
        inputs:
          script: "git clone https://github.com/microsoft/artifacts-credprovider.git"
        displayName: "Clone Azure Credentials Plugin for NuGet Repo"

      - task: PowerShell@2
        inputs:
          filePath: "d:/a/1/s/artifacts-credprovider/helpers/installcredprovider.ps1"
          arguments: "-AddNetfx"
        displayName: "Install Azure Credentials Plugin for NuGet"

      - template: setup-repo.yml

      # - task: NuGetCommand@2
      #   displayName: NuGet restore - FluentTester
      #   inputs:
      #     command: restore
      #     noCache: true
      #     restoreSolution: apps/windows/windows/FluentTester.sln
      #     verbosityRestore: Detailed # Options: quiet, normal, detailed

      - script: yarn windows
        displayName: Running UWP App
        workingDirectory: apps/windows

      # Wait for app to launch. A workaround to avoid WinAppDriver error: Failed to locate opened application window with appId
      - task: PowerShell@2
        displayName: Wait for app to launch
        inputs:
          targetType: inline # filePath | inline
          script: |
            Start-Sleep -Seconds 30

      - script: yarn e2etest
        displayName: Running UWP E2E Tests
        workingDirectory: apps/windows
