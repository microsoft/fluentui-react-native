steps:
  - checkout: self
    persistCredentials: true

  - template: setup-repo-min-build.yml

  # Clean Derived Data
  - script: |
      rm -rf $(Build.Repository.LocalPath)/DerivedData
    displayName: 'Clean DerivedData'

  - script: |
      sudo gem install cocoapods
    displayName: 'Install CocoaPods Environment'

  - script: |
      yarn bundle
    workingDirectory: apps/win32
    displayName: 'Bundling win32'

  # generate the sanitizedBuildNumber environment variable
  - bash: '.ado/scripts/generate_build_number.sh'
    displayName: 'Generate Build Number'

  # pack the nuspec
  - task: NuGetCommand@2
    displayName: 'NuGet pack'
    inputs:
      command: pack
      packagesToPack: 'package.nuspec'
      buildProperties: buildNumber=$(sanitizedBuildNumber);commitId=$(Build.SourceVersion);repoUri=$(Build.Repository.Uri)

  # push the package package
  - task: NuGetCommand@2
    displayName: 'NuGet push'
    inputs:
      command: push
      packagesToPush: '$(Build.ArtifactStagingDirectory)/Microsoft.FluentUI.ReactNative.*.nupkg'
      nuGetFeedType: external
      publishFeedCredentials: react-native
